#cloud-config
#
# YardaLab base cloud-init
# ------------------------
# Minimal, opinionated, and reusable baseline for all VPS deployments.
# Target OS: Ubuntu 22.04 LTS
#

############################
# System bootstrap
############################

package_update: true
package_upgrade: false

timezone: UTC

packages:
  # --- Base utilities ---
  - ca-certificates
  - curl
  - wget
  - gnupg
  - lsb-release

  # --- System & debugging ---
  - htop
  - vim
  - jq
  - tmux

  # --- Networking & diagnostics ---
  - iproute2
  - dnsutils

  # --- Common admin helpers ---
  - git
  - unzip
  - sudo

############################
# User & SSH setup (DETERMINISTIC)
############################

users:
  - name: ubuntu
    shell: /bin/bash
    groups: [sudo]
    sudo: "ALL=(ALL) NOPASSWD:ALL"
    ssh_authorized_keys:
%{ for key in ssh_public_keys ~}
      - ${key}
%{ endfor ~}

disable_root: true
ssh_pwauth: false

############################
# Files & configuration
############################

write_files:
  # --- SSH hardening ---
  - path: /etc/ssh/sshd_config.d/99-yardalab.conf
    owner: root:root
    permissions: "0644"
    content: |
      PasswordAuthentication no
      PermitRootLogin no
      ChallengeResponseAuthentication no
      PubkeyAuthentication yes
      UsePAM yes
      X11Forwarding no
      AllowTcpForwarding no
      AllowAgentForwarding no

  # --- Unattended upgrades ---
  - path: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root:root
    permissions: "0644"
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";

  # --- Persistent journald ---
  - path: /etc/systemd/journald.conf.d/yardalab.conf
    owner: root:root
    permissions: "0644"
    content: |
      [Journal]
      Storage=persistent
      SystemMaxUse=200M
      RuntimeMaxUse=50M
      MaxRetentionSec=1month

############################
# Logging & finalization
############################

package_reboot_if_required: true

output:
  all: "| tee -a /var/log/cloud-init-output.log"

runcmd:
  - systemctl restart ssh
  - systemctl restart systemd-journald
